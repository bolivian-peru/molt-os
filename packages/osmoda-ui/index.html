<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>osModa</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0f;
      --text: #e0e0e8;
      --muted: #888899;
      --dim: #555566;
      --surface: #1a1a2e;
      --border: #222233;
      --accent: #3b82f6;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      overflow: hidden;
    }

    ::-webkit-scrollbar { width: 0; }
    * { scrollbar-width: none; }

    #app {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* === Welcome screen === */
    #welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    #welcome.hidden {
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
      position: absolute;
      inset: 0;
    }
    #welcome h1 {
      font-size: 42px;
      font-weight: 700;
      letter-spacing: -1px;
      color: #ffffff;
      margin-bottom: 8px;
    }
    #welcome p {
      color: var(--muted);
      font-size: 16px;
    }

    /* === Messages === */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 24px 120px;
      display: none;
    }
    #messages.visible { display: block; }

    .messages-inner {
      max-width: 720px;
      margin: 0 auto;
    }

    .message {
      margin-bottom: 24px;
      animation: fadeIn 0.3s ease;
    }
    .message-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .message-content {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text);
    }
    .message.user .message-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
    }

    /* Markdown */
    .message-content code {
      background: #222233;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: "JetBrains Mono", "Fira Code", "Courier New", monospace;
      font-size: 14px;
    }
    .message-content pre {
      background: #111122;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      margin: 12px 0;
    }
    .message-content pre code {
      background: none;
      padding: 0;
      font-size: 14px;
    }
    .message-content strong { color: #ffffff; }
    .message-content ul, .message-content ol {
      margin: 8px 0;
      padding-left: 24px;
    }
    .message-content li { margin-bottom: 4px; }
    .message-content p { margin-bottom: 8px; }
    .message-content p:last-child { margin-bottom: 0; }

    /* Typing indicator */
    .typing {
      display: inline-flex;
      gap: 4px;
      padding: 4px 0;
    }
    .typing span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: pulse 1.4s infinite;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    /* === Input area === */
    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 24px 24px;
      background: linear-gradient(transparent, var(--bg) 30%);
    }
    .input-inner {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    #input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      padding: 12px 16px;
      resize: none;
      outline: none;
      line-height: 1.5;
      max-height: 200px;
      transition: border-color 0.2s;
    }
    #input:focus { border-color: var(--accent); }
    #input::placeholder { color: var(--dim); }

    #send {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
      white-space: nowrap;
    }
    #send:hover { background: #2563eb; }
    #send:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Status indicator */
    #status {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--dim);
      opacity: 0;
      transition: opacity 0.3s;
    }
    #status.visible { opacity: 1; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="welcome">
      <h1>osModa</h1>
      <p>Your computer is ready</p>
    </div>
    <div id="messages">
      <div class="messages-inner" id="messages-inner"></div>
    </div>
    <div id="input-area">
      <div class="input-inner">
        <textarea id="input" rows="1" placeholder="Ask osModa anything..." autofocus></textarea>
        <button id="send">Send</button>
      </div>
    </div>
    <div id="status"></div>
  </div>

  <script>
    var messages = [];
    var ws = null;
    var isStreaming = false;
    var currentResponse = '';
    var reconnectDelay = 1000;

    var welcomeEl = document.getElementById('welcome');
    var messagesEl = document.getElementById('messages');
    var messagesInner = document.getElementById('messages-inner');
    var inputEl = document.getElementById('input');
    var sendBtn = document.getElementById('send');
    var statusEl = document.getElementById('status');

    // Auto-resize textarea
    inputEl.addEventListener('input', function() {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
    });

    // Enter to send, Shift+Enter for newline
    inputEl.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    function sendMessage() {
      var text = inputEl.value.trim();
      if (!text || isStreaming) return;

      // Transition from welcome to chat
      if (messages.length === 0) {
        welcomeEl.classList.add('hidden');
        messagesEl.classList.add('visible');
      }

      addMessage('user', text);
      inputEl.value = '';
      inputEl.style.height = 'auto';

      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'message', content: text }));
        isStreaming = true;
        sendBtn.disabled = true;
        showTyping();
      }
    }

    function addMessage(role, content) {
      messages.push({ role: role, content: content });
      renderMessage(role, content);
    }

    function renderMessage(role, content, id) {
      var div = document.createElement('div');
      div.className = 'message ' + role;
      if (id) div.id = id;
      var label = role === 'user' ? 'You' : 'osModa';
      var rendered = role === 'user' ? escapeHtml(content) : renderMarkdown(content);
      div.innerHTML = '<div class="message-label">' + label + '</div>' +
        '<div class="message-content">' + rendered + '</div>';
      messagesInner.appendChild(div);
      scrollToBottom();
    }

    function showTyping() {
      var div = document.createElement('div');
      div.className = 'message assistant';
      div.id = 'typing';
      div.innerHTML = '<div class="message-label">osModa</div>' +
        '<div class="message-content">' +
        '<div class="typing"><span></span><span></span><span></span></div>' +
        '</div>';
      messagesInner.appendChild(div);
      scrollToBottom();
    }

    function removeTyping() {
      var el = document.getElementById('typing');
      if (el) el.remove();
    }

    function updateStreaming(content) {
      removeTyping();
      var el = document.getElementById('streaming');
      if (!el) {
        renderMessage('assistant', content, 'streaming');
      } else {
        el.querySelector('.message-content').innerHTML = renderMarkdown(content);
      }
      scrollToBottom();
    }

    function finalizeStreaming() {
      var el = document.getElementById('streaming');
      if (el) {
        el.removeAttribute('id');
        messages.push({ role: 'assistant', content: currentResponse });
      }
      removeTyping();
      currentResponse = '';
      isStreaming = false;
      sendBtn.disabled = false;
      inputEl.focus();
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setStatus(text) {
      statusEl.textContent = text;
      statusEl.classList.toggle('visible', !!text);
    }

    // === Markdown rendering (lightweight) ===
    function renderMarkdown(text) {
      // Escape HTML first to prevent XSS from assistant responses
      text = escapeHtml(text);
      // Code blocks
      text = text.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
      // Inline code
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Bold
      text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic
      text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Unordered lists
      text = text.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
      text = text.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
      // Paragraphs
      text = text.replace(/\n\n/g, '</p><p>');
      text = text.replace(/\n/g, '<br>');
      return '<p>' + text + '</p>';
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // === WebSocket ===
    function connectWS() {
      var proto = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(proto + '://' + location.host + '/');

      ws.onopen = function() {
        setStatus('');
        reconnectDelay = 1000;
      };

      ws.onmessage = function(event) {
        try {
          var data = JSON.parse(event.data);
          handleMessage(data);
        } catch(e) {
          // Plain text chunk
          if (isStreaming) {
            currentResponse += event.data;
            updateStreaming(currentResponse);
          }
        }
      };

      ws.onclose = function() {
        setStatus('Reconnecting...');
        setTimeout(connectWS, reconnectDelay);
        reconnectDelay = Math.min(reconnectDelay * 1.5, 10000);
      };

      ws.onerror = function() {};
    }

    function handleMessage(data) {
      // Stream chunk (various formats)
      if (data.type === 'chunk' || data.type === 'content_block_delta') {
        var text = data.content || (data.delta && data.delta.text) || data.text || '';
        currentResponse += text;
        updateStreaming(currentResponse);
        return;
      }

      // Stream complete
      if (data.type === 'done' || data.type === 'message_stop' || data.type === 'message_complete') {
        finalizeStreaming();
        return;
      }

      // Full message (non-streaming)
      if (data.type === 'message' && data.role === 'assistant') {
        removeTyping();
        addMessage('assistant', data.content);
        isStreaming = false;
        sendBtn.disabled = false;
        return;
      }

      // Generic content
      var content = data.content || data.text || data.message;
      if (content) {
        if (isStreaming) {
          currentResponse += content;
          updateStreaming(currentResponse);
        } else {
          addMessage('assistant', content);
        }
      }
    }

    connectWS();
    inputEl.focus();
  </script>
</body>
</html>
